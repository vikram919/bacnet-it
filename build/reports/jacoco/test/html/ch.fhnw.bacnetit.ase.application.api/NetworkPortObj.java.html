<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NetworkPortObj.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">bacnet-it</a> &gt; <a href="index.source.html" class="el_package">ch.fhnw.bacnetit.ase.application.api</a> &gt; <span class="el_source">NetworkPortObj.java</span></div><h1>NetworkPortObj.java</h1><pre class="source lang-java linenums">package ch.fhnw.bacnetit.ase.application.api;

import java.io.FileInputStream;
import java.io.InputStream;
import java.net.URI;
import java.security.KeyStore;

import javax.net.ssl.KeyManager;
import javax.net.ssl.KeyManagerFactory;
import javax.net.ssl.X509KeyManager;

import ch.fhnw.bacnetit.ase.application.configuration.api.KeystoreConfig;

/**
 * Each BACnetDevice instance has one NetworkPortObject. The NetworkProtObject
 * provides information about the accessibility
 *
 * @author IMVS, FHNW
 *
 */
public class NetworkPortObj {

    // private _CharacterString uri;
    private URI uri;
    private final KeystoreConfig keystoreConfig;

    public NetworkPortObj(final String protocol, final int port,
<span class="fc" id="L28">            final KeystoreConfig keystoreConfig) {</span>
<span class="fc" id="L29">        this.keystoreConfig = keystoreConfig;</span>
        try {
<span class="fc" id="L31">            this.getFQDN(protocol, port);</span>
<span class="nc" id="L32">        } catch (final Exception e) {</span>
<span class="nc" id="L33">            e.printStackTrace();</span>
<span class="fc" id="L34">        }</span>
<span class="fc" id="L35">    }</span>

    // public _CharacterString getUri() {
    public URI getUri() {
<span class="nc" id="L39">        return this.uri;</span>
    }

    /**
     * The Operational Device Identity Certificate contains the Subject
     * Alternative Name. The Subject Alternative Name is the url of the host,
     * where the BACnetDevice is running.
     *
     * @param protocol
     *            The Subject Alternative Name doesn't contain information about
     *            the protocol
     * @param port
     *            The Subject Alternative Name doesn't contain information about
     *            the port
     * @throws Exception
     */
    private void getFQDN(final String protocol, final int port) {
        // TODO FQDN does not contain protocol and host parts!
        // URI is only needed for registering in DNS, or is it...
<span class="nc" id="L58">        try (final InputStream readStreamk = new FileInputStream(</span>
                keystoreConfig.path)) {
<span class="nc" id="L60">            X509KeyManager x509 = null;</span>
<span class="nc" id="L61">            final KeyStore ks = KeyStore.getInstance(&quot;JKS&quot;);</span>
            // Open the configured KeyStore

<span class="nc" id="L64">            ks.load(readStreamk, keystoreConfig.pass.toCharArray());</span>
<span class="nc" id="L65">            readStreamk.close();</span>
            final KeyManagerFactory kmf = KeyManagerFactory
<span class="nc" id="L67">                    .getInstance(KeyManagerFactory.getDefaultAlgorithm());</span>
<span class="nc" id="L68">            kmf.init(ks, keystoreConfig.pass.toCharArray());</span>

<span class="nc bnc" id="L70" title="All 2 branches missed.">            for (final KeyManager km : kmf.getKeyManagers()) {</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">                if (km instanceof X509KeyManager) {</span>
<span class="nc" id="L72">                    x509 = (X509KeyManager) km;</span>
<span class="nc" id="L73">                    break;</span>
                }
            }

<span class="nc bnc" id="L77" title="All 2 branches missed.">            if (x509 == null) {</span>
<span class="nc" id="L78">                throw new Exception(&quot;FQDN from Keystore could not be read&quot;);</span>
            }

            // this.uri = new _CharacterString(protocol + &quot;://&quot;
            // + ((String) x509
            // .getCertificateChain(keystoreConfig.alias)[0]
            // .getSubjectAlternativeNames().iterator()
            // .next().get(1))
            // + &quot;:&quot; + port);
<span class="nc" id="L87">            this.uri = new URI(protocol + &quot;://&quot;</span>
                    + ((String) x509
<span class="nc" id="L89">                            .getCertificateChain(keystoreConfig.alias)[0]</span>
<span class="nc" id="L90">                                    .getSubjectAlternativeNames().iterator()</span>
<span class="nc" id="L91">                                    .next().get(1))</span>
                    + &quot;:&quot; + port);

<span class="pc bnc" id="L94" title="All 8 branches missed.">        } catch (final Exception io) {</span>
<span class="fc" id="L95">            System.err.println(io);</span>

<span class="nc" id="L97">        }</span>
<span class="fc" id="L98">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>