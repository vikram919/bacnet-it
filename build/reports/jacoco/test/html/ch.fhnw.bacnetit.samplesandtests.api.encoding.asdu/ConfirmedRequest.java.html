<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConfirmedRequest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">bacnet-it</a> &gt; <a href="index.source.html" class="el_package">ch.fhnw.bacnetit.samplesandtests.api.encoding.asdu</a> &gt; <span class="el_source">ConfirmedRequest.java</span></div><h1>ConfirmedRequest.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * ============================================================================
 * GNU General Public License
 * ============================================================================
 *
 * Copyright (C) 2017 University of Applied Sciences and Arts,
 * Northwestern Switzerland FHNW,
 * Institute of Mobile and Distributed Systems.
 * All rights reserved.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the
 * GNU General Public License for more details.
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see http://www.gnu.orglicenses.
 *******************************************************************************/
package ch.fhnw.bacnetit.samplesandtests.api.encoding.asdu;

import ch.fhnw.bacnetit.samplesandtests.api.encoding.enums.MaxApduLength;
import ch.fhnw.bacnetit.samplesandtests.api.encoding.enums.MaxSegments;
import ch.fhnw.bacnetit.samplesandtests.api.encoding.exception.BACnetException;
import ch.fhnw.bacnetit.samplesandtests.api.encoding.type.constructed.ServicesSupported;
import ch.fhnw.bacnetit.samplesandtests.api.encoding.util.ByteQueue;
import ch.fhnw.bacnetit.samplesandtests.api.service.confirmed.ConfirmedRequestService;

public class ConfirmedRequest extends ASDU {
    private static final long serialVersionUID = -8338535273752015450L;

    public static final byte TYPE_ID = 0;

    public static int getHeaderSize(final boolean segmented) {
<span class="nc bnc" id="L38" title="All 2 branches missed.">        if (segmented) {</span>
<span class="nc" id="L39">            return 6;</span>
        }
<span class="nc" id="L41">        return 4;</span>
    }

    /**
     * This parameter indicates whether or not the confirmed service request is
     * entirely, or only partially, contained in the present PDU. If the request
     * is present in its entirety, the value of the 'segmented-message'
     * parameter shall be FALSE. If the present PDU contains only a segment of
     * the request, this parameter shall be TRUE.
     */
    private boolean segmentedMessage;

    /**
     * This parameter is only meaningful if the 'segmented-message' parameter is
     * TRUE. If 'segmented-message' is TRUE, then the 'more-follows' parameter
     * shall be TRUE for all segments comprising the confirmed service request
     * except for the last and shall be FALSE for the final segment. If
     * 'segmented-message' is FALSE, then 'more-follows' shall be set FALSE by
     * the encoder and shall be ignored by the decoder.
     */
    private boolean moreFollows;

    /**
     * This parameter shall be TRUE if the device issuing the confirmed request
     * will accept a segmented complex acknowledgment as a response. It shall be
     * FALSE otherwise. This parameter is included in the confirmed request so
     * that the responding device may determine how to convey its response.
     */
    private boolean segmentedResponseAccepted;

    /**
     * This optional parameter specifies the maximum number of segments that the
     * device will accept. This parameter is included in the confirmed request
     * so that the responding device may determine how to convey its response.
     * The parameter shall be encoded as follows: B'000' Unspecified number of
     * segments accepted. B'001' 2 segments accepted. B'010' 4 segments
     * accepted. B'011' 8 segments accepted. B'100' 16 segments accepted. B'101'
     * 32 segments accepted. B'110' 64 segments accepted. B'111' Greater than 64
     * segments accepted.
     */
    private MaxSegments maxSegmentsAccepted;

    /**
     * This parameter specifies the maximum size of a single APDU that the
     * issuing device will accept. This parameter is included in the confirmed
     * request so that the responding device may determine how to convey its
     * response. The parameter shall be encoded as follows: B'0000' Up to
     * MinimumMessageSize (50 octets) B'0001' Up to 128 octets B'0010' Up to 206
     * octets (fits in a LonTalk frame) B'0011' Up to 480 octets (fits in an
     * ARCNET frame) B'0100' Up to 1024 octets B'0101' Up to 1476 octets (fits
     * in an ISO 8802-3 frame) B'0110' reserved by ASHRAE B'0111' reserved by
     * ASHRAE B'1000' reserved by ASHRAE B'1001' reserved by ASHRAE B'1010'
     * reserved by ASHRAE B'1011' reserved by ASHRAE B'1100' reserved by ASHRAE
     * B'1101' reserved by ASHRAE B'1110' reserved by ASHRAE B'1111' reserved by
     * ASHRAE
     */
    private MaxApduLength maxApduLengthAccepted;

    /**
     * This parameter shall be an integer in the range 0 - 255 assigned by the
     * service requester. It shall be used to associate the response to a
     * confirmed service request with the original request. In the absence of
     * any error, the 'invokeID' shall be returned by the service provider in a
     * BACnet-SimpleACK-PDU or a BACnet-ComplexACK-PDU. In the event of an error
     * condition, the 'invokeID' shall be returned by the service provider in a
     * BACnet-Error-PDU, BACnet-Reject-PDU, or BACnet-Abort-PDU as appropriate.
     *
     * The 'invokeID' shall be generated by the device issuing the service
     * request. It shall be unique for all outstanding confirmed request APDUs
     * generated by the device. The same 'invokeID' shall be used for all
     * segments of a segmented service request. Once an 'invokeID' has been
     * assigned to an APDU, it shall be maintained within the device until
     * either a response APDU is received with the same 'invokeID' or a no
     * response timer expires (see 5.3). In either case, the 'invokeID' value
     * shall then be released for reassignment. The algorithm used to pick a
     * value out of the set of unused values is a local matter. The storage
     * mechanism for maintaining the used 'invokeID' values within the
     * requesting and responding devices is also a local matter. The requesting
     * device may use a single 'invokeID' space for all its confirmed APDUs or
     * multiple 'invokeID' spaces (one per destination device address) as
     * desired. Since the 'invokeID' values are only source-device-unique, the
     * responding device shall maintain the 'invokeID' as well as the requesting
     * device address until a response has been sent. The responding device may
     * discard the 'invokeID' information after a response has been sent.
     */
    private byte invokeId;

    /**
     * This optional parameter is only present if the 'segmented-message'
     * parameter is TRUE. In this case, the 'sequence-number' shall be a
     * sequentially incremented unsigned integer, modulo 256, which identifies
     * each segment of a segmented request. The value of the received
     * 'sequence-number' is used by the responder to acknowledge the receipt of
     * one or more segments of a segmented request. The 'sequence-number' of the
     * first segment of a segmented request shall be zero.
     */
    private int sequenceNumber;

    /**
     * This optional parameter is only present if the 'segmented-message'
     * parameter is TRUE. In this case, the 'proposed-windowsize' parameter
     * shall specify as an unsigned binary integer the maximum number of message
     * segments containing 'invokeID' the sender is able or willing to send
     * before waiting for a segment acknowledgment PDU (see 5.2 and 5.3). The
     * value of the 'proposed-window-size' shall be in the range 1 - 127.
     */
    private int proposedWindowSize;

    /**
     * This parameter shall contain the parameters of the specific service that
     * is being requested, encoded according to the rules of 20.2. These
     * parameters are defined in the individual service descriptions in this
     * standard and are represented in Clause 21 in accordance with the rules of
     * ASN.1.
     */
    private byte serviceChoice;

    private ConfirmedRequestService serviceRequest;

    /**
     * This field is used to allow parsing of only the APDU so that those fields
     * are available in case there is a problem parsing the service request.
     */
    private ByteQueue serviceData;

    public ConfirmedRequest(final boolean segmentedMessage,
            final boolean moreFollows, final boolean segmentedResponseAccepted,
            final MaxSegments maxSegmentsAccepted,
            final MaxApduLength maxApduLengthAccepted, final byte invokeId,
            final int sequenceNumber, final int proposedWindowSize,
<span class="nc" id="L171">            final ConfirmedRequestService serviceRequest) {</span>

<span class="nc" id="L173">        setFields(segmentedMessage, moreFollows, segmentedResponseAccepted,</span>
                maxSegmentsAccepted, maxApduLengthAccepted, invokeId,
                sequenceNumber, proposedWindowSize,
<span class="nc" id="L176">                serviceRequest.getChoiceId());</span>

<span class="nc" id="L178">        this.serviceRequest = serviceRequest;</span>
<span class="nc" id="L179">    }</span>

    public ConfirmedRequest(final boolean segmentedMessage,
            final boolean moreFollows, final boolean segmentedResponseAccepted,
            final MaxSegments maxSegmentsAccepted,
            final MaxApduLength maxApduLengthAccepted, final byte invokeId,
            final int sequenceNumber, final int proposedWindowSize,
<span class="nc" id="L186">            final byte serviceChoice, final ByteQueue serviceData) {</span>

<span class="nc" id="L188">        setFields(segmentedMessage, moreFollows, segmentedResponseAccepted,</span>
                maxSegmentsAccepted, maxApduLengthAccepted, invokeId,
                sequenceNumber, proposedWindowSize, serviceChoice);

<span class="nc" id="L192">        this.serviceData = serviceData;</span>
<span class="nc" id="L193">    }</span>

    private void setFields(final boolean segmentedMessage,
            final boolean moreFollows, final boolean segmentedResponseAccepted,
            final MaxSegments maxSegmentsAccepted,
            final MaxApduLength maxApduLengthAccepted, final byte invokeId,
            final int sequenceNumber, final int proposedWindowSize,
            final byte serviceChoice) {
<span class="nc" id="L201">        this.segmentedMessage = segmentedMessage;</span>
<span class="nc" id="L202">        this.moreFollows = moreFollows;</span>
<span class="nc" id="L203">        this.segmentedResponseAccepted = segmentedResponseAccepted;</span>
<span class="nc" id="L204">        this.maxSegmentsAccepted = maxSegmentsAccepted;</span>
<span class="nc" id="L205">        this.maxApduLengthAccepted = maxApduLengthAccepted;</span>
<span class="nc" id="L206">        this.invokeId = invokeId;</span>
<span class="nc" id="L207">        this.sequenceNumber = sequenceNumber;</span>
<span class="nc" id="L208">        this.proposedWindowSize = proposedWindowSize;</span>
<span class="nc" id="L209">        this.serviceChoice = serviceChoice;</span>
<span class="nc" id="L210">    }</span>

    @Override
    public byte getPduType() {
<span class="nc" id="L214">        return TYPE_ID;</span>
    }

    public byte getInvokeId() {
<span class="nc" id="L218">        return invokeId;</span>
    }

    public int getSequenceNumber() {
<span class="nc" id="L222">        return sequenceNumber;</span>
    }

    public MaxApduLength getMaxApduLengthAccepted() {
<span class="nc" id="L226">        return maxApduLengthAccepted;</span>
    }

    public MaxSegments getMaxSegmentsAccepted() {
<span class="nc" id="L230">        return maxSegmentsAccepted;</span>
    }

    public boolean isMoreFollows() {
<span class="nc" id="L234">        return moreFollows;</span>
    }

    public int getProposedWindowSize() {
<span class="nc" id="L238">        return proposedWindowSize;</span>
    }

    public boolean isSegmentedMessage() {
<span class="nc" id="L242">        return segmentedMessage;</span>
    }

    public boolean isSegmentedResponseAccepted() {
<span class="nc" id="L246">        return segmentedResponseAccepted;</span>
    }

    public ConfirmedRequestService getServiceRequest() {
<span class="nc" id="L250">        return serviceRequest;</span>
    }

    public void appendServiceData(final ByteQueue data) {
<span class="nc" id="L254">        this.serviceData.push(data);</span>
<span class="nc" id="L255">    }</span>

    public ByteQueue getServiceData() {
<span class="nc" id="L258">        return serviceData;</span>
    }

    @Override
    public void write(final ByteQueue queue) {
<span class="nc bnc" id="L263" title="All 6 branches missed.">        queue.push(getShiftedTypeId(TYPE_ID) | (segmentedMessage ? 8 : 0)</span>
                | (moreFollows ? 4 : 0) | (segmentedResponseAccepted ? 2 : 0));
<span class="nc" id="L265">        queue.push(((maxSegmentsAccepted.getId() &amp; 7) &lt;&lt; 4)</span>
<span class="nc" id="L266">                | (maxApduLengthAccepted.getId() &amp; 0xf));</span>
<span class="nc" id="L267">        queue.push(invokeId);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        if (segmentedMessage) {</span>
<span class="nc" id="L269">            queue.push(sequenceNumber);</span>
<span class="nc" id="L270">            queue.push(proposedWindowSize);</span>
        }
<span class="nc" id="L272">        queue.push(serviceChoice);</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">        if (serviceRequest != null) {</span>
<span class="nc" id="L274">            serviceRequest.write(queue);</span>
        } else {
<span class="nc" id="L276">            queue.push(serviceData);</span>
        }
<span class="nc" id="L278">    }</span>

    ConfirmedRequest(final ServicesSupported servicesSupported,
<span class="nc" id="L281">            final ByteQueue queue) throws BACnetException {</span>
<span class="nc" id="L282">        queue.pop();</span>
<span class="nc" id="L283">        serviceChoice = queue.pop();</span>
<span class="nc" id="L284">        serviceChoice = (byte) ((serviceChoice &amp; 0xff) &gt;&gt; 4);</span>
<span class="nc" id="L285">        serviceData = new ByteQueue(queue.peekAll());</span>

<span class="nc" id="L287">        ConfirmedRequestService.checkConfirmedRequestService(servicesSupported,</span>
                serviceChoice);
<span class="nc" id="L289">        serviceRequest = ConfirmedRequestService</span>
<span class="nc" id="L290">                .createConfirmedRequestService(serviceChoice, queue);</span>
<span class="nc" id="L291">    }</span>

    public void parseServiceData() throws BACnetException {
<span class="nc bnc" id="L294" title="All 2 branches missed.">        if (serviceData != null) {</span>
<span class="nc" id="L295">            serviceRequest = ConfirmedRequestService</span>
<span class="nc" id="L296">                    .createConfirmedRequestService(serviceChoice, serviceData);</span>
<span class="nc" id="L297">            serviceData = null;</span>
        }
<span class="nc" id="L299">    }</span>

    public ASDU clone(final boolean moreFollows, final int sequenceNumber,
            final int actualSegWindow, final ByteQueue serviceData) {
<span class="nc" id="L303">        return new ConfirmedRequest(this.segmentedMessage, moreFollows,</span>
                this.segmentedResponseAccepted, this.maxSegmentsAccepted,
                this.maxApduLengthAccepted, this.invokeId, sequenceNumber,
                actualSegWindow, this.serviceChoice, serviceData);
    }

    @Override
    public String toString() {
<span class="nc" id="L311">        return &quot;ConfirmedRequest(segmentedMessage=&quot; + segmentedMessage</span>
                + &quot;, moreFollows=&quot; + moreFollows
                + &quot;, segmentedResponseAccepted=&quot; + segmentedResponseAccepted
                + &quot;, maxSegmentsAccepted=&quot; + maxSegmentsAccepted
                + &quot;, maxApduLengthAccepted=&quot; + maxApduLengthAccepted
                + &quot;, invokeId=&quot; + invokeId + &quot;, sequenceNumber=&quot;
                + sequenceNumber + &quot;, proposedWindowSize=&quot; + proposedWindowSize
                + &quot;, serviceChoice=&quot; + serviceChoice + &quot;, serviceRequest=&quot;
                + serviceRequest + &quot;)&quot;;
    }

    @Override
    public int hashCode() {
<span class="nc" id="L324">        final int PRIME = 31;</span>
<span class="nc" id="L325">        int result = 1;</span>
<span class="nc" id="L326">        result = PRIME * result + invokeId;</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">        result = PRIME * result + ((maxApduLengthAccepted == null) ? 0</span>
<span class="nc" id="L328">                : maxApduLengthAccepted.hashCode());</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">        result = PRIME * result + ((maxSegmentsAccepted == null) ? 0</span>
<span class="nc" id="L330">                : maxSegmentsAccepted.hashCode());</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">        result = PRIME * result + (moreFollows ? 1231 : 1237);</span>
<span class="nc" id="L332">        result = PRIME * result + proposedWindowSize;</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">        result = PRIME * result + (segmentedMessage ? 1231 : 1237);</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">        result = PRIME * result + (segmentedResponseAccepted ? 1231 : 1237);</span>
<span class="nc" id="L335">        result = PRIME * result + sequenceNumber;</span>
<span class="nc" id="L336">        result = PRIME * result + serviceChoice;</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">        result = PRIME * result</span>
<span class="nc" id="L338">                + ((serviceData == null) ? 0 : serviceData.hashCode());</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">        result = PRIME * result</span>
<span class="nc" id="L340">                + ((serviceRequest == null) ? 0 : serviceRequest.hashCode());</span>
<span class="nc" id="L341">        return result;</span>
    }

    @Override
    public boolean equals(final Object obj) {
<span class="nc bnc" id="L346" title="All 2 branches missed.">        if (this == obj) {</span>
<span class="nc" id="L347">            return true;</span>
        }
<span class="nc bnc" id="L349" title="All 2 branches missed.">        if (obj == null) {</span>
<span class="nc" id="L350">            return false;</span>
        }
<span class="nc bnc" id="L352" title="All 2 branches missed.">        if (getClass() != obj.getClass()) {</span>
<span class="nc" id="L353">            return false;</span>
        }
<span class="nc" id="L355">        final ConfirmedRequest other = (ConfirmedRequest) obj;</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">        if (invokeId != other.invokeId) {</span>
<span class="nc" id="L357">            return false;</span>
        }
<span class="nc bnc" id="L359" title="All 2 branches missed.">        if (maxApduLengthAccepted == null) {</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">            if (other.maxApduLengthAccepted != null) {</span>
<span class="nc" id="L361">                return false;</span>
            }
<span class="nc bnc" id="L363" title="All 2 branches missed.">        } else if (!maxApduLengthAccepted.equals(other.maxApduLengthAccepted)) {</span>
<span class="nc" id="L364">            return false;</span>
        }
<span class="nc bnc" id="L366" title="All 2 branches missed.">        if (maxSegmentsAccepted != other.maxSegmentsAccepted) {</span>
<span class="nc" id="L367">            return false;</span>
        }
<span class="nc bnc" id="L369" title="All 2 branches missed.">        if (moreFollows != other.moreFollows) {</span>
<span class="nc" id="L370">            return false;</span>
        }
<span class="nc bnc" id="L372" title="All 2 branches missed.">        if (proposedWindowSize != other.proposedWindowSize) {</span>
<span class="nc" id="L373">            return false;</span>
        }
<span class="nc bnc" id="L375" title="All 2 branches missed.">        if (segmentedMessage != other.segmentedMessage) {</span>
<span class="nc" id="L376">            return false;</span>
        }
<span class="nc bnc" id="L378" title="All 2 branches missed.">        if (segmentedResponseAccepted != other.segmentedResponseAccepted) {</span>
<span class="nc" id="L379">            return false;</span>
        }
<span class="nc bnc" id="L381" title="All 2 branches missed.">        if (sequenceNumber != other.sequenceNumber) {</span>
<span class="nc" id="L382">            return false;</span>
        }
<span class="nc bnc" id="L384" title="All 2 branches missed.">        if (serviceChoice != other.serviceChoice) {</span>
<span class="nc" id="L385">            return false;</span>
        }
<span class="nc bnc" id="L387" title="All 2 branches missed.">        if (serviceData == null) {</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">            if (other.serviceData != null) {</span>
<span class="nc" id="L389">                return false;</span>
            }
<span class="nc bnc" id="L391" title="All 2 branches missed.">        } else if (!serviceData.equals(other.serviceData)) {</span>
<span class="nc" id="L392">            return false;</span>
        }
<span class="nc bnc" id="L394" title="All 2 branches missed.">        if (serviceRequest == null) {</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">            if (other.serviceRequest != null) {</span>
<span class="nc" id="L396">                return false;</span>
            }
<span class="nc bnc" id="L398" title="All 2 branches missed.">        } else if (!serviceRequest.equals(other.serviceRequest)) {</span>
<span class="nc" id="L399">            return false;</span>
        }
<span class="nc" id="L401">        return true;</span>
    }

    @Override
    public boolean expectsReply() {
<span class="nc" id="L406">        return true;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>